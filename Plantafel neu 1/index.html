<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plantafel Freylich</title>
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --brand:#0b6cff; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
    --r:14px; --shadow:0 6px 18px rgba(0,0,0,.06);
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .brand{font-weight:800}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  button.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .pill{border-radius:999px;padding:6px 10px}
  input,select,textarea{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font:inherit}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:12px}
  .day{margin-bottom:12px}
  .day .head{display:flex;justify-content:space-between;margin-bottom:6px}
  .job{border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0;background:#fafafa}
  .job .title{background:#0f172a;color:#fff;border-radius:10px;padding:8px 10px;margin:-2px 0 6px 0;font-weight:700}
  .meta{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{justify-content:flex-end}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border:1px solid var(--line);border-radius:999px;padding:3px 8px;background:#fff;font-size:.85rem}
  .badge{border-radius:999px;padding:3px 9px;border:1px solid var(--line);background:#fff;font-size:.82rem}
  .legend .dot{width:9px;height:9px;border-radius:999px;display:inline-block;margin-right:6px}
  .g{background:var(--ok)} .a{background:var(--warn)} .r{background:var(--bad)}
  .hidden{display:none!important}
  .yeargrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .month{min-height:140px}
  .muted{color:var(--muted)}
  @media(max-width:1000px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Plantafel Freylich</div>
    <div class="toolbar">
      <button id="btnBack">Zurück</button>
      <button id="btnToday">Heute</button>
      <button id="btnNext">Weiter</button>

      <button id="btn14"   class="pill">14 Tage</button>
      <button id="btn4w"   class="pill">4 Wochen</button>
      <button id="btnYear" class="pill">Jahresübersicht</button>

      <select id="empFilter" title="Mitarbeiter-Filter"><option value="__all">Alle Mitarbeiter</option></select>
      <input id="searchSite" placeholder="Baustelle suchen…" />

      <button id="btnMaster" class="badge">Stammdaten</button>
      <span id="authState" class="badge">Offline</span>
      <button id="btnLogin"  class="badge">Anmelden</button>
      <button id="btnLogout" class="badge hidden">Abmelden</button>
    </div>
  </header>

  <div class="grid">
    <main id="mainCol">
      <div id="view14" class="card"><div class="row"><strong>14 Tage (Mo–Fr)</strong></div><div id="days14"></div></div>
      <div id="view4w" class="card hidden"><div class="row"><strong>4 Wochen (Mo–Fr)</strong></div><div id="weeks4"></div></div>
      <div id="viewYear" class="card hidden"><div class="row"><strong>Jahresübersicht</strong></div><div id="yearGrid" class="yeargrid"></div></div>
    </main>

    <aside>
      <div class="card">
        <div class="row"><strong>Parkplatz: Kleinbaustellen</strong><span id="kbCount" class="muted"></span></div>
        <div id="kbList" class="chips muted" style="margin-top:6px">Keine Einträge.</div>
        <div class="row right" data-write><button id="btnAddKB" class="badge">+ Kleinbaustelle</button></div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Legende</strong>
        <div class="legend" style="margin-top:6px">
          <div><span class="dot g"></span>Geplant</div>
          <div><span class="dot a"></span>Verschoben</div>
          <div><span class="dot r"></span>Storniert</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Modal -->
<div id="modalBack" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:50">
  <div id="modalCard" class="card" style="max-width:560px;width:100%"></div>
</div>

<!-- Firebase (CDN, modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ---- Deine bestätigte Firebase-Konfiguration ----
  const firebaseConfig = {
    apiKey: "AIzaSyAxqqR3lxV-vQttjlaaHnkmIQ5Vgrva3U",
    authDomain: "plantafel-freylich.firebaseapp.com",
    projectId: "plantafel-freylich",
    storageBucket: "plantafel-freylich.firebasestorage.app",
    messagingSenderId: "1428812257773",
    appId: "1:428812257773:web:d6db9f0c3075a1bff3fe4",
    measurementId: "G-MNGGTFK53R"
  };

  // ---- Admin-E-Mails (dürfen schreiben) ----
  const ADMIN_EMAILS = [
    "herbert.frey@bedachungen-frey.de",
    "thomas.frey@bedachungen-frey.de",
    "patrick.thieme@bedachungen-frey.de"
  ];

  // Init
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Helper
  const $ = s=>document.querySelector(s);
  const modalBack = $("#modalBack"), modalCard=$("#modalCard");
  function openModal(node){ modalCard.innerHTML=""; modalCard.appendChild(node); modalBack.style.display="flex"; modalBack.onclick=e=>{ if(e.target===modalBack) closeModal(); }; }
  function closeModal(){ modalBack.style.display="none"; modalCard.innerHTML=""; }
  const isWorkday = d => { const wd=d.getDay(); return wd>=1 && wd<=5; }; // Mo..Fr
  const fmtDE = d => d.toLocaleDateString("de-DE",{weekday:"long", day:"2-digit", month:"2-digit", year:"numeric"});
  const ymd   = d => d.toISOString().slice(0,10);
  const fromY = s => new Date(s+"T00:00:00");
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
  const monday = d=>{ const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); x.setHours(0,0,0,0); return x; };
  const weekOf = d=>{ const t=new Date(d), dayNr=(t.getDay()+6)%7; t.setDate(t.getDate()-dayNr+3); const firstThu=new Date(t.getFullYear(),0,4); const diff=t-firstThu; return 1+Math.round(diff/604800000); };

  // Auth
  let canWrite=false;
  onAuthStateChanged(auth, async (user)=>{
    if(user?.email){
      $("#authState").textContent = user.email;
      $("#btnLogin").classList.add("hidden");
      $("#btnLogout").classList.remove("hidden");
      canWrite = ADMIN_EMAILS.map(x=>x.toLowerCase()).includes(user.email.toLowerCase());
    } else {
      $("#btnLogin").classList.remove("hidden");
      $("#btnLogout").classList.add("hidden");
      canWrite=false;
      try{ await signInAnonymously(auth); $("#authState").textContent="Anonym"; }catch(e){ $("#authState").textContent="Offline"; }
    }
    toggleWriteUI();
    await loadMasters();
    await renderAll();
    await renderParking();
  });

  $("#btnLogin").onclick = ()=>{
    const box=document.createElement("div");
    box.innerHTML=`
      <h3 style="margin:0 0 8px">Anmelden (Admin)</h3>
      <div class="row" style="flex-wrap:nowrap"><input id="loginEmail" placeholder="E-Mail" style="flex:1"><input id="loginPass" type="password" placeholder="Passwort" style="flex:1"></div>
      <div class="row right" style="margin-top:8px"><button id="mCancel">Abbrechen</button><button class="primary" id="mOk">Anmelden</button></div>`;
    setTimeout(()=>{
      box.querySelector("#mCancel").onclick=closeModal;
      box.querySelector("#mOk").onclick=async()=>{
        const email=box.querySelector("#loginEmail").value.trim();
        const pass =box.querySelector("#loginPass").value.trim();
        try{ await signInWithEmailAndPassword(auth,email,pass); closeModal(); }catch(e){ alert("Login fehlgeschlagen: "+(e.message||e)); }
      };
    });
    openModal(box);
  };
  $("#btnLogout").onclick=()=>signOut(auth);
  function toggleWriteUI(){ document.querySelectorAll("[data-write]").forEach(n=>n.classList.toggle("hidden",!canWrite)); }

  // Stammdaten
  let EMP=[], VEH=[], SITES=[];
  async function loadMasters(){
    const [e,v,s] = await Promise.all([
      getDocs(collection(db,"employees")),
      getDocs(collection(db,"vehicles")),
      getDocs(collection(db,"sites"))
    ]);
    EMP = e.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    VEH = v.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    SITES= s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    const sel=$("#empFilter"); const keep=sel.value||"__all";
    sel.innerHTML='<option value="__all">Alle Mitarbeiter</option>'+EMP.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
    sel.value=keep;
  }

  // Navigation / Views
  let anchor = monday(new Date()); // Startwoche (Montag)
  $("#btnToday").onclick = ()=>{ anchor=monday(new Date()); renderAll(); };
  $("#btnBack").onclick  = ()=>{ anchor = addDays(anchor, -7); renderAll(); };
  $("#btnNext").onclick  = ()=>{ anchor = addDays(anchor,  7); renderAll(); };
  $("#btn14").onclick    = ()=>showView("14");
  $("#btn4w").onclick    = ()=>showView("4w");
  $("#btnYear").onclick  = ()=>showView("year");
  $("#empFilter").onchange=()=>renderAll();
  $("#searchSite").oninput=()=>renderAll();
  $("#btnMaster").onclick = ()=>{
    if(!canWrite) return alert("Nur Admin darf Stammdaten ändern.");
    const box=document.createElement("div");
    box.innerHTML=`
      <h3 style="margin:0 0 8px">Stammdaten</h3>
      <div class="card" style="margin-bottom:10px">
        <strong>Mitarbeiter</strong>
        <div class="row" style="margin-top:6px"><input id="empName" placeholder="Name" style="flex:1"><input id="empColor" type="color" value="#3b82f6"><button id="empSave">+ Speichern</button></div>
        <div id="empList" class="chips" style="margin-top:8px"></div>
      </div>
      <div class="card" style="margin-bottom:10px">
        <strong>Fahrzeuge</strong>
        <div class="row" style="margin-top:6px"><input id="vehName" placeholder="Bezeichnung" style="flex:1"><button id="vehSave">+ Speichern</button></div>
        <div id="vehList" class="chips" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <strong>Baustellen</strong>
        <div class="row" style="margin-top:6px"><input id="siteName" placeholder="Name" style="flex:1"><button id="siteSave">+ Speichern</button></div>
        <div id="siteList" class="chips" style="margin-top:8px"></div>
      </div>
      <div class="row right" style="margin-top:8px"><button id="mClose">Schließen</button></div>
    `;
    setTimeout(()=>{
      const renderLists=()=>{
        $("#empList").innerHTML = EMP.map(e=>`<span class="chip" style="border-color:${e.color||'#94a3b8'}">${e.name}</span>`).join("")||'<span class="muted">leer</span>';
        $("#vehList").innerHTML = VEH.map(v=>`<span class="chip">${v.name}</span>`).join("")||'<span class="muted">leer</span>';
        $("#siteList").innerHTML= SITES.map(s=>`<span class="chip">${s.name}</span>`).join("")||'<span class="muted">leer</span>';
      };
      renderLists();
      $("#empSave").onclick=async()=>{
        const n=$("#empName").value.trim(); if(!n) return;
        const c=$("#empColor").value || "#3b82f6";
        await addDoc(collection(db,"employees"),{name:n,color:c,created:serverTimestamp()});
        await loadMasters(); renderLists(); $("#empName").value="";
      };
      $("#vehSave").onclick=async()=>{
        const n=$("#vehName").value.trim(); if(!n) return;
        await addDoc(collection(db,"vehicles"),{name:n,created:serverTimestamp()});
        await loadMasters(); renderLists(); $("#vehName").value="";
      };
      $("#siteSave").onclick=async()=>{
        const n=$("#siteName").value.trim(); if(!n) return;
        await addDoc(collection(db,"sites"),{name:n,created:serverTimestamp()});
        await loadMasters(); renderLists(); $("#siteName").value="";
      };
      $("#mClose").onclick=closeModal;
    });
    openModal(box);
  };

  function showView(v){
    $("#view14").classList.toggle("hidden", v!=="14");
    $("#view4w").classList.toggle("hidden", v!=="4w");
    $("#viewYear").classList.toggle("hidden", v!=="year");
    renderAll();
  }

  async function renderAll(){
    const v14=!$("#view14").classList.contains("hidden");
    const v4w=!$("#view4w").classList.contains("hidden");
    const vY =!$("#viewYear").classList.contains("hidden");
    if(v14) await render14();
    if(v4w) await render4w();
    if(vY)  await renderYear();
  }

  // Daten holen
  async function getAssignments(){ const s=await getDocs(collection(db,"assignments")); return s.docs.map(d=>({id:d.id,...d.data()})); }
  async function getAbsences(){ const s=await getDocs(collection(db,"absences")); return s.docs.map(d=>({id:d.id,...d.data()})); }
  async function getParking(){ const s=await getDocs(collection(db,"parking")); return s.docs.map(d=>({id:d.id,...d.data()})); }

  // 14 Tage = 2 Arbeitswochen (Mo–Fr)
  async function render14(){
    const host=$("#days14"); host.innerHTML="";
    const weekStart = monday(anchor);
    const workdays = [];
    // Woche 1: Mo–Fr
    for(let i=0;i<5;i++) workdays.push(addDays(weekStart,i));
    // Woche 2: Mo–Fr
    for(let i=0;i<5;i++) workdays.push(addDays(weekStart,7+i));

    const [ASS, ABS] = await Promise.all([getAssignments(), getAbsences()]);
    const filterEmp = $("#empFilter").value||"__all";
    const q = ($("#searchSite").value||"").toLowerCase();

    for(const d of workdays){
      const ds = ymd(d);
      const card = document.createElement("div");
      card.className="card day";
      card.innerHTML = `
        <div class="head"><div><strong>${d.toLocaleDateString('de-DE',{weekday:'long'})}</strong></div><div class="muted">${fmtDE(d)}</div></div>
        <div class="chips muted" id="abs-${ds}"></div>
        <div class="row" data-write><button class="badge" id="addAbs-${ds}">+ Abwesenheit</button><button class="badge" id="addJob-${ds}">+ Einsatz hinzufügen</button></div>
        <div id="jobs-${ds}"></div>
      `;
      host.appendChild(card);

      // Abwesenheiten
      const aDay = ABS.filter(a=>a.date===ds);
      const krank = aDay.filter(a=>a.kind==='krank').map(a=>a.employeeName).join(", ")||"–";
      const urlaub= aDay.filter(a=>a.kind==='urlaub').map(a=>a.employeeName).join(", ")||"–";
      const schule= aDay.filter(a=>a.kind==='schule').map(a=>a.employeeName).join(", ")||"–";
      card.querySelector(`#abs-${ds}`).innerHTML = `<span class="badge">Krank: ${krank}</span> <span class="badge">Urlaub: ${urlaub}</span> <span class="badge">Schule: ${schule}</span>`;

      // Einsätze
      const items = ASS.filter(j=>{
        const s=fromY(j.startDate), e=j.endDate?fromY(j.endDate):fromY(j.startDate);
        const inDay = d>=s && d<=e;
        const okEmp = filterEmp==="__all" || (j.employees||[]).some(eid=>eid.id===filterEmp);
        const okQ   = !q || (j.title||"").toLowerCase().includes(q);
        return inDay && okEmp && okQ;
      }).sort((a,b)=> (a.title||"").localeCompare(b.title||""));

      for(const j of items){
        const siteName = SITES.find(s=>s.id===j.siteId)?.name || j.title || "Baustelle";
        const emps = (j.employees||[]).map(e=>{
          const x=EMP.find(z=>z.id===e.id); return `<span class="chip" style="border-color:${x?.color||'#94a3b8'}">${x?.name||e.id}</span>`;
        }).join(" ") || "–";
        const vehs = (j.vehicles||[]).map(v=>{ const x=VEH.find(z=>z.id===v.id); return `<span class="chip">${x?.name||v.id}</span>`; }).join(" ") || "–";

        const div=document.createElement("div");
        div.className="job";
        div.innerHTML=`
          <div class="title">${siteName}</div>
          <div class="meta"><strong>Fahrzeuge:</strong> ${vehs}</div>
          <div class="meta"><strong>Mitarbeiter:</strong> ${emps}</div>
          <div class="row right" style="margin-top:6px" data-write>
            <button class="badge" data-edit="${j.id}">Bearbeiten</button>
            <button class="badge" data-move="${j.id}">Verschieben</button>
            <button class="badge" data-del="${j.id}" style="border-color:#fee2e2;color:#b91c1c">Löschen</button>
          </div>
        `;
        card.querySelector(`#jobs-${ds}`).appendChild(div);
      }

      // Events
      setTimeout(()=>{
        card.querySelector(`#addAbs-${ds}`)?.addEventListener("click", ()=>openModal(renderAbsForm(ds)));
        card.querySelector(`#addJob-${ds}`)?.addEventListener("click", ()=>openModal(renderJobForm({startDate:ds})));
        card.querySelectorAll("[data-edit]").forEach(b=> b.onclick=()=>editJob(b.dataset.edit));
        card.querySelectorAll("[data-move]").forEach(b=> b.onclick=()=>moveJob(b.dataset.move));
        card.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>delJob(b.dataset.del));
      },0);
    }
    toggleWriteUI();
  }

  // 4 Wochen (nur Mo–Fr)
  async function render4w(){
    const host=$("#weeks4"); host.innerHTML="";
    const ASS = await getAssignments();
    for(let w=0; w<4; w++){
      const wMon = addDays(monday(anchor), w*7);
      const wEnd = addDays(wMon,4); // Mo–Fr
      const box=document.createElement("div");
      box.className="card";
      box.innerHTML = `<div class="row"><strong>KW ${weekOf(wMon)}</strong><span class="muted">${fmtDE(wMon)} – ${fmtDE(wEnd)}</span></div>`;
      const items = ASS.filter(j=>{
        const s=fromY(j.startDate), e=j.endDate?fromY(j.endDate):fromY(j.startDate);
        return !(e < wMon || s > addDays(wMon,6));
      }).sort((a,b)=> (a.startDate||"").localeCompare(b.startDate||""));
      for(const j of items){
        const div=document.createElement("div"); div.className="job";
        const siteName = SITES.find(s=>s.id===j.siteId)?.name || j.title || "Baustelle";
        div.innerHTML = `
          <div class="title">${siteName}</div>
          <div class="meta">von ${fmtDE(fromY(j.startDate))}${j.endDate? " bis "+fmtDE(fromY(j.endDate)):""}</div>
          <div class="row right" data-write style="margin-top:6px">
            <button class="badge" data-edit="${j.id}">Bearbeiten</button>
            <button class="badge" data-move="${j.id}">Verschieben</button>
            <button class="badge" data-del="${j.id}" style="border-color:#fee2e2;color:#b91c1c">Löschen</button>
          </div>
        `;
        box.appendChild(div);
      }
      host.appendChild(box);
    }
    setTimeout(()=>{
      host.querySelectorAll("[data-edit]").forEach(b=> b.onclick=()=>editJob(b.dataset.edit));
      host.querySelectorAll("[data-move]").forEach(b=> b.onclick=()=>moveJob(b.dataset.move));
      host.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>delJob(b.dataset.del));
    },0);
    toggleWriteUI();
  }

  // Jahresübersicht
  async function renderYear(){
    const grid=$("#yearGrid"); grid.innerHTML="";
    const yDoc = doc(db,"yearplan","main");
    const snap = await getDoc(yDoc);
    const data = snap.exists()? snap.data() : {};
    const months = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    months.forEach((m,i)=>{
      const el = document.createElement("div"); el.className="card month";
      el.innerHTML = `<strong>${m}</strong><textarea id="yn-${i}" rows="5" style="width:100%;margin-top:6px">${data["m"+(i+1)]||""}</textarea>
        <div class="row right" data-write><button class="badge" data-save="${i}">Speichern</button></div>`;
      grid.appendChild(el);
    });
    setTimeout(()=>{
      grid.querySelectorAll("[data-save]").forEach(b=>{
        b.onclick = async ()=>{
          if(!canWrite) return;
          const i=+b.dataset.save, v=$("#yn-"+i).value;
          await setDoc(yDoc,{["m"+(i+1)]:v,updated:serverTimestamp()},{merge:true});
        };
      });
    },0);
    toggleWriteUI();
  }

  // Abwesenheit-Form
  function renderAbsForm(dateYmd){
    const box=document.createElement("div");
    const empOpts = EMP.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
    box.innerHTML=`
      <h3 style="margin:0 0 8px">Abwesenheit</h3>
      <div class="row"><input type="date" id="abDate" value="${dateYmd}"><select id="abEmp">${empOpts}</select><select id="abKind"><option value="krank">Krank</option><option value="urlaub">Urlaub</option><option value="schule">Schule</option></select></div>
      <div class="row right" style="margin-top:8px"><button id="mCancel">Abbrechen</button><button class="primary" id="mOk">Speichern</button></div>
    `;
    setTimeout(()=>{
      $("#mCancel").onclick=closeModal;
      $("#mOk").onclick=async()=>{
        if(!canWrite) return;
        const id=$("#abEmp").value; const emp=EMP.find(x=>x.id===id);
        await addDoc(collection(db,"absences"),{date:$("#abDate").value, kind:$("#abKind").value, employeeId:id, employeeName:emp?.name||"", created:serverTimestamp()});
        closeModal(); renderAll();
      };
    });
    return box;
  }

  // Einsatz-Form
  function renderJobForm(pref={}){
    const box=document.createElement("div");
    const siteOpts= SITES.map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
    const empChecks= EMP.map(e=>`<label class="row" style="gap:6px"><input type="checkbox" value="${e.id}"><span class="chip" style="border-color:${e.color||'#94a3b8'}">${e.name}</span></label>`).join("");
    const vehChecks= VEH.map(v=>`<label class="row" style="gap:6px"><input type="checkbox" value="${v.id}"><span class="chip">${v.name}</span></label>`).join("");
    box.innerHTML=`
      <h3 style="margin:0 0 8px">Einsatz anlegen</h3>
      <div class="row" style="flex-wrap:wrap">
        <input id="jTitle" placeholder="Titel / Baustelle" style="flex:1" value="${pref.title||""}">
        <select id="jSite"><option value="">– Baustelle wählen –</option>${siteOpts}</select>
      </div>
      <div class="row"><input type="date" id="jStart" value="${pref.startDate||ymd(new Date())}"><input type="date" id="jEnd" value="${pref.endDate||""}" placeholder="Ende (optional)"></div>
      <div class="card" style="margin:8px 0"><strong>Fahrzeuge</strong><div style="max-height:120px;overflow:auto">${vehChecks||'<span class="muted">Keine Fahrzeuge angelegt.</span>'}</div></div>
      <div class="card" style="margin:8px 0"><strong>Mitarbeiter</strong><div style="max-height:160px;overflow:auto">${empChecks||'<span class="muted">Keine Mitarbeiter angelegt.</span>'}</div></div>
      <textarea id="jNotes" rows="3" placeholder="Notizen / Adresse / Hinweise…"></textarea>
      <div class="row right" style="margin-top:8px"><button id="mCancel">Abbrechen</button><button class="primary" id="mOk">Speichern</button></div>
    `;
    setTimeout(()=>{
      $("#mCancel").onclick=closeModal;
      $("#mOk").onclick=async()=>{
        if(!canWrite) return;
        const empIds=[...box.querySelectorAll('input[type=checkbox]')].filter(x=>x.checked && EMP.find(e=>e.id===x.value)).map(x=>({id:x.value}));
        const vehIds=[...box.querySelectorAll('input[type=checkbox]')].filter(x=>x.checked && VEH.find(v=>v.id===x.value)).map(x=>({id:x.value}));
        await addDoc(collection(db,"assignments"),{
          title: $("#jTitle").value.trim(),
          siteId: $("#jSite").value||null,
          startDate: $("#jStart").value,
          endDate: $("#jEnd").value||null,
          employees: empIds,
          vehicles: vehIds,
          notes: $("#jNotes").value.trim(),
          status: "planned",
          created: serverTimestamp()
        });
        closeModal(); renderAll();
      };
    });
    return box;
  }

  // Job-Aktionen
  async function editJob(jobId){
    const ref=doc(db,"assignments",jobId); const s=await getDoc(ref); if(!s.exists()) return;
    const j=s.data(); const form=renderJobForm(j);
    setTimeout(()=>{
      form.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        if(j.employees?.some(e=>e.id===cb.value) || j.vehicles?.some(v=>v.id===cb.value)) cb.checked=true;
      });
      form.querySelector("#jTitle").value = j.title||"";
      form.querySelector("#jSite").value  = j.siteId||"";
      form.querySelector("#jStart").value = j.startDate||ymd(new Date());
      form.querySelector("#jEnd").value   = j.endDate||"";
      form.querySelector("#jNotes").value = j.notes||"";
      form.querySelector("#mOk").onclick = async ()=>{
        if(!canWrite) return;
        const empIds=[...form.querySelectorAll('input[type=checkbox]')].filter(x=>x.checked && EMP.find(e=>e.id===x.value)).map(x=>({id:x.value}));
        const vehIds=[...form.querySelectorAll('input[type=checkbox]')].filter(x=>x.checked && VEH.find(v=>v.id===x.value)).map(x=>({id:x.value}));
        await updateDoc(ref,{
          title: form.querySelector("#jTitle").value.trim(),
          siteId: form.querySelector("#jSite").value||null,
          startDate: form.querySelector("#jStart").value,
          endDate: form.querySelector("#jEnd").value||null,
          employees: empIds, vehicles: vehIds, notes: form.querySelector("#jNotes").value.trim()
        });
        closeModal(); renderAll();
      };
    },0);
    openModal(form);
  }
  async function moveJob(jobId){
    if(!canWrite) return;
    const ref=doc(db,"assignments",jobId); const s=await getDoc(ref); if(!s.exists()) return;
    const j=s.data();
    const box=document.createElement("div");
    box.innerHTML=`
      <h3 style="margin:0 0 8px">Einsatz verschieben</h3>
      <div class="row"><input id="mvStart" type="date" value="${j.startDate||ymd(new Date())}"><input id="mvEnd" type="date" value="${j.endDate||""}"></div>
      <div class="row right" style="margin-top:8px"><button id="mCancel">Abbrechen</button><button class="primary" id="mOk">Verschieben</button></div>`;
    setTimeout(()=>{
      $("#mCancel").onclick=closeModal;
      $("#mOk").onclick=async()=>{ await updateDoc(ref,{startDate:$("#mvStart").value,endDate:$("#mvEnd").value||null,status:"moved"}); closeModal(); renderAll(); };
    });
    openModal(box);
  }
  async function delJob(jobId){
    if(!canWrite) return;
    if(!confirm("Einsatz löschen?")) return;
    await deleteDoc(doc(db,"assignments",jobId));
    renderAll();
  }

  // Kleinbaustellen
  $("#btnAddKB").onclick=()=>{
    if(!canWrite) return;
    const box=document.createElement("div");
    box.innerHTML=`
      <h3 style="margin:0 0 8px">Kleinbaustelle</h3>
      <input id="kbTitle" placeholder="Kurzbeschreibung / Adresse">
      <div class="row right" style="margin-top:8px"><button id="mCancel">Abbrechen</button><button class="primary" id="mOk">Speichern</button></div>`;
    setTimeout(()=>{
      $("#mCancel").onclick=closeModal;
      $("#mOk").onclick=async()=>{ await addDoc(collection(db,"parking"),{title:$("#kbTitle").value.trim(),created:serverTimestamp()}); closeModal(); renderParking(); };
    });
    openModal(box);
  };
  async function renderParking(){
    const list = await getParking();
    const box = $("#kbList");
    if(!list.length){ box.textContent="Keine Einträge."; $("#kbCount").textContent=""; return; }
    $("#kbCount").textContent = `${list.length} Einträge`;
    box.innerHTML="";
    list.sort((a,b)=>(a.title||"").localeCompare(b.title||"")).forEach(p=>{
      const row=document.createElement("div"); row.className="row"; row.style.justifyContent="space-between";
      row.innerHTML=`
        <span>${p.title||"(ohne Titel)"}</span>
        <span class="row hidden" data-write>
          <button class="badge" data-plan="${p.id}">Einplanen</button>
          <button class="badge" data-del="${p.id}" style="border-color:#fee2e2;color:#b91c1c">Löschen</button>
        </span>`;
      box.appendChild(row);
    });
    setTimeout(()=>{
      box.querySelectorAll("[data-plan]").forEach(b=> b.onclick=()=>planParking(b.dataset.plan));
      box.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>deleteParking(b.dataset.del));
      toggleWriteUI();
    },0);
  }
  async function planParking(id){
    if(!canWrite) return;
    const ref=doc(db,"parking",id); const s=await getDoc(ref); if(!s.exists()) return;
    const p=s.data();
    openModal(renderJobForm({title:p.title, startDate:ymd(new Date())}));
    // (Optional: nach Speichern Parkplatz löschen)
  }
  async function deleteParking(id){
    if(!canWrite) return; if(!confirm("Eintrag löschen?")) return;
    await deleteDoc(doc(db,"parking",id)); renderParking();
  }

  // Start
  function showView(v){ $("#view14").classList.toggle("hidden", v!=="14"); $("#view4w").classList.toggle("hidden", v!=="4w"); $("#viewYear").classList.toggle("hidden", v!=="year"); }
  showView("14");
  (async function init(){ await loadMasters(); await renderAll(); await renderParking(); })();
</script>
</body>
</html>
